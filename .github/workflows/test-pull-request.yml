name: Test Pull Request

on:
  pull_request:
    branches:
    - main
env:
  STACKS_FILEPATH: "images.json"

jobs:
  preparation:
    name: Preparation
    runs-on: ubuntu-24.04
    outputs:
      stacks: ${{ steps.get-stacks.outputs.stacks }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # gets full history

      - name: Get stacks images
        id: get-stacks
        run: |
          if [ -f ${{ env.STACKS_FILEPATH }} ]; then
            stacks=$(jq -c '.images' images.json)
          else
            # Default fallback if images.json is missing
            stacks=$(jq -n -c '[
                {
                  "name": "default",
                  "config_dir": "stack",
                  "output_dir": "build",
                  "create_build_image": true
                }
            ]')
          fi

          # Ensure the JSON structure is clean for the matrix
          stacks=$(echo "$stacks" | jq -c 'map({
              name,
              config_dir,
              output_dir,
              create_build_image})')

          echo "stacks=$stacks" >> "$GITHUB_OUTPUT"

  create_stack:
    name: Create Stack
    needs: [ preparation ]
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        stack: ${{ fromJSON(needs.preparation.outputs.stacks) }}
    steps:
    - name: Checkout
      uses: actions/checkout@v6

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Create stack ${{ matrix.stack.name }}
      id: create-stack
      run: |
        scripts/create.sh --stack-dir ${{ matrix.stack.config_dir }} \
                          --build-dir ${{ matrix.stack.output_dir }}

    - name: Upload run image
      uses: actions/upload-artifact@v6
      with:
        name: current-run-image-${{ matrix.stack.name }}
        path: "${{ matrix.stack.output_dir }}/run.oci"
        if-no-files-found: error
        retention-days: 1

    - name: Upload build image
      if: ${{ matrix.stack.create_build_image == true }}
      uses: actions/upload-artifact@v6
      with:
        name: current-build-image-${{ matrix.stack.name }}
        path: "${{ matrix.stack.output_dir }}/build.oci"
        if-no-files-found: error
        retention-days: 1

  test:
    name: Acceptance Test
    needs: [ preparation, create_stack ]
    runs-on: ubuntu-24.04
    steps:
    - name: Setup Go
      uses: actions/setup-go@v6
      with:
        go-version: stable

    - name: Checkout
      uses: actions/checkout@v6

    - name: Download All Images
      uses: actions/download-artifact@v6
      with:
        pattern: current-*-image-*
        path: download-images

    # v6 downloads patterns into subfolders: download-images/<artifact-name>/<file>
    # We move them to the actual output_dir expected by the test script.
    - name: Reconstruct OCI Structure
      run: |
        echo '${{ needs.preparation.outputs.stacks }}' | jq -c '.[]' | while read -r stack; do
          name=$(echo "$stack" | jq -r '.name')
          out_dir=$(echo "$stack" | jq -r '.output_dir')
          create_build=$(echo "$stack" | jq -r '.create_build_image')

          mkdir -p "$out_dir"

          downloaded_src_run="download-images/current-run-image-${name}/run.oci"
          if [ -f "$downloaded_src_run" ]; then
            mv "$downloaded_src_run" "${out_dir}/run.oci"
          else
            echo "Run image missing for $name"
            exit 1
          fi

          downloaded_src_build="download-images/current-build-image-${name}/build.oci"
          if [ "$create_build" = "true" ]; then
            if [ -f "$downloaded_src_build" ]; then
              mv "$downloaded_src_build" "${out_dir}/build.oci"
            else
              echo "Build image missing for $name"
              exit 1
            fi
          fi
        done

    - name: Run Acceptance Tests
      run: ./scripts/test.sh --validate-stack-builds

  upload-payload:
    name: Upload Workflow Event Payload
    runs-on: ubuntu-24.04
    steps:
    - name: Upload Artifact
      uses: actions/upload-artifact@v6
      with:
        name: event-payload
        path: ${{ github.event_path }}
        retention-days: 1